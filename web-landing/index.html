<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Saravafy</title>
    <meta
      name="description"
      content="Um acervo digital vivo de pontos de Umbanda"
    />

    <link rel="icon" href="/images/favicon-light-mode.png" type="image/png" />
    <link
      rel="icon"
      href="/images/favicon-light-mode.png"
      type="image/png"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      href="/images/favicon-dark-mode.png"
      type="image/png"
      media="(prefers-color-scheme: dark)"
    />

    <link rel="stylesheet" href="/styles.css?v=2026-01-10-13" />
  </head>
  <body>
    <header class="top-header" aria-label="Saravafy">
      <div class="top-header__inner">
        <div class="top-header__brand" aria-label="Saravafy">
          <img
            class="top-header__logo top-header__logo--light"
            src="/images/saravafy-logo-full-light.png"
            alt="Saravafy"
            decoding="async"
          />
          <img
            class="top-header__logo top-header__logo--dark"
            src="/images/saravafy-logo-full-dark.png"
            alt="Saravafy"
            decoding="async"
          />
        </div>

        <div class="top-header__actions" aria-label="Ações">
          <button
            class="btn-primary"
            type="button"
            id="installBtn"
            data-install-url=""
            aria-haspopup="dialog"
            aria-controls="installModal"
          >
            Instalar app
          </button>
        </div>
      </div>
    </header>

    <section class="hero" aria-label="Saravafy">
      <div class="hero__inner">
        <div class="hero__content">
          <h1 class="hero__title">Saravafy</h1>
          <p class="hero__subtitle">
            Um acervo digital vivo de pontos de Umbanda.
          </p>

          <p class="hero__copy">
            Aqui, o som é memória.<br />
            A palavra é ensinamento.<br />
            E cada ponto é parte de uma herança viva que atravessa gerações.
          </p>

          <button
            class="btn-secondary hero__cta"
            type="button"
            data-install-url=""
            aria-haspopup="dialog"
            aria-controls="installModal"
          >
            Instalar App
          </button>

          <div class="hero__cta-microcopy" aria-label="Disponibilidade">
            Disponível apenas para Android no momento
          </div>
        </div>
      </div>
    </section>

    <main class="container">
      <section class="card" aria-label="Manifesto">
        <p>
          O Saravafy é um projeto cultural e comunitário criado para preservar,
          registrar e compartilhar pontos de Umbanda com respeito,
          responsabilidade e acesso livre.
        </p>
      </section>

      <section class="card" aria-labelledby="o-que-e">
        <h2 id="o-que-e">O que é o Saravafy</h2>

        <p>
          O Saravafy nasceu do entendimento de que os pontos de Umbanda não são
          apenas cantos — são registros históricos, espirituais e culturais.
        </p>

        <p>
          Cada batida de atabaque carrega um caminho.<br />
          Cada letra guarda uma história.<br />
          Cada melodia mantém viva a tradição dos terreiros.
        </p>

        <p>
          O Saravafy existe para que esse conhecimento não se perca, não seja
          distorcido e não seja apropriado de forma irresponsável.<br />
          É uma casa digital construída pela comunidade, para a comunidade.
        </p>
      </section>

      <section class="card" aria-labelledby="o-que-acreditamos">
        <h2 id="o-que-acreditamos">O que acreditamos</h2>

        <div class="list-items" aria-label="Princípios do Saravafy">
          <div class="list-item">
            <div class="list-item__title">O sagrado é coletivo</div>
            <div class="list-item__preview">
              O conhecimento espiritual não pertence a indivíduos, marcas ou
              plataformas. Ele pertence ao povo, à ancestralidade e à vivência
              nos terreiros.
            </div>
          </div>

          <div class="list-item">
            <div class="list-item__title">Memória viva</div>
            <div class="list-item__preview">
              Preservar não é engessar. É manter vivo, acessível e respeitado
              aquilo que foi transmitido pela oralidade e pela prática.
            </div>
          </div>

          <div class="list-item">
            <div class="list-item__title">Respeito acima de tudo</div>
            <div class="list-item__preview">
              Sem vaidade.<br />
              Sem hierarquia espiritual.<br />
              Sem exploração do sagrado.<br />
              <br />
              O Saravafy não cria autoridade — apenas abre espaço.
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="o-que-nao-e">
        <h2 id="o-que-nao-e">O que o Saravafy não é</h2>

        <p>Para deixar claro desde o início:</p>

        <ul>
          <li>Não é comércio da fé</li>
          <li>Não monetiza o sagrado</li>
          <li>Não transforma tradição em produto</li>
          <li>Não substitui o terreiro, a gira ou a vivência espiritual</li>
        </ul>

        <p>
          O Saravafy é complemento, registro e memória — nunca substituição.
        </p>
      </section>

      <section class="card" aria-labelledby="como-funciona">
        <h2 id="como-funciona">Como funciona</h2>

        <p>
          O Saravafy funciona como um acervo digital acessível por aplicativo.
        </p>

        <p>Tudo isso de forma gratuita, comunitária e respeitosa.</p>
      </section>

      <footer class="landing-footer" aria-label="Links legais">
        <a class="landing-footer__link" href="/politica-de-privacidade"
          >Política de Privacidade</a
        >
      </footer>
    </main>

    <div
      class="modal"
      id="installModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="installModalTitle"
      aria-describedby="installModalDesc"
      hidden
    >
      <div class="modal__backdrop" data-close-modal="true"></div>

      <div class="modal__panel" role="document">
        <h2 id="installModalTitle">Instalar app</h2>

        <div id="installModalDesc" class="modal__body">
          <ul class="modal__list">
            <li>
              O Saravafy ainda não está disponível nas lojas oficiais porque é
              um projeto cultural independente, mantido pela própria comunidade.
            </li>
            <li>Por isso, o acesso acontece diretamente pelo aplicativo.</li>
            <li>
              O Android pode pedir uma confirmação extra na primeira instalação
              — isso é normal e acontece apenas uma vez.
            </li>
          </ul>
        </div>

        <div class="modal__actions">
          <button class="btn-primary" type="button" data-close-modal>
            Entendi
          </button>
        </div>
      </div>
    </div>

    <script src="/config.js?v=2026-01-10-1"></script>
    <script>
      (function () {
        var triggers = document.querySelectorAll(
          '[data-install-url][aria-controls="installModal"]'
        );
        var modal = document.getElementById("installModal");
        if (!modal || !triggers || triggers.length === 0) return;

        var lastFocused = null;
        var currentInstallUrl = null;
        var lastFetchPromise = null;

        function getSupabaseConfig() {
          var url = window.SARAVAFY_SUPABASE_URL;
          var key = window.SARAVAFY_SUPABASE_ANON_KEY;
          if (!url || !key) return null;
          return { url: String(url), key: String(key) };
        }

        function setInstallUrl(url) {
          currentInstallUrl = url ? String(url) : null;

          for (var i = 0; i < triggers.length; i++) {
            if (currentInstallUrl) {
              triggers[i].setAttribute("data-install-url", currentInstallUrl);
            } else {
              triggers[i].setAttribute("data-install-url", "");
            }
          }
        }

        function fetchInstallUrlFresh() {
          var cfg = getSupabaseConfig();
          if (!cfg) {
            setInstallUrl(null);
            return Promise.resolve(null);
          }

          // De-dupe concurrent fetches (but still refetch on each page show).
          if (lastFetchPromise) return lastFetchPromise;

          var endpoint =
            cfg.url.replace(/\/$/, "") + "/rest/v1/rpc/get_app_install_url";

          var controller = null;
          var timeoutId = null;
          try {
            controller = new AbortController();
            timeoutId = window.setTimeout(function () {
              try {
                controller.abort();
              } catch (_e) {}
            }, 8000);
          } catch (_e) {
            controller = null;
          }

          lastFetchPromise = fetch(endpoint, {
            method: "POST",
            cache: "no-store",
            headers: {
              apikey: cfg.key,
              authorization: "Bearer " + cfg.key,
              "content-type": "application/json",
              "cache-control": "no-store, no-cache, must-revalidate, max-age=0",
              pragma: "no-cache",
            },
            body: "{}",
            signal: controller ? controller.signal : undefined,
          })
            .then(function (res) {
              if (!res || !res.ok)
                throw new Error("Failed to fetch install URL");
              return res.json();
            })
            .then(function (json) {
              var url = json && json.value ? String(json.value) : "";

              // Guard against placeholder.
              if (!url || url === "pending") {
                setInstallUrl(null);
                return null;
              }

              setInstallUrl(url);
              return url;
            })
            .catch(function () {
              // Fail closed: do not keep any previous URL.
              setInstallUrl(null);
              return null;
            })
            .finally(function () {
              if (timeoutId) window.clearTimeout(timeoutId);
              lastFetchPromise = null;
            });

          return lastFetchPromise;
        }

        function setOpen(open) {
          if (open) {
            lastFocused = document.activeElement;
            modal.hidden = false;
            document.body.classList.add("modal-open");
            var closeEl = modal.querySelector("button[data-close-modal]");
            if (closeEl && closeEl.focus) closeEl.focus();
          } else {
            modal.hidden = true;
            document.body.classList.remove("modal-open");
            if (lastFocused && lastFocused.focus) lastFocused.focus();
          }
        }

        function triggerDownload(url) {
          if (!url) return;

          // Dispara download sem abrir nova aba/janela.
          // Observação: o comportamento final depende do browser/servidor (Content-Disposition).
          var iframe = document.createElement("iframe");
          iframe.style.display = "none";
          iframe.src = url;
          iframe.setAttribute("aria-hidden", "true");
          document.body.appendChild(iframe);

          // Limpa depois de um tempo (evita acumular iframes).
          window.setTimeout(function () {
            try {
              document.body.removeChild(iframe);
            } catch (_e) {}
          }, 2000);
        }

        // Always fetch a fresh URL when the page is shown (covers normal load + bfcache restore).
        window.addEventListener("pageshow", function () {
          fetchInstallUrlFresh();
        });

        for (var i = 0; i < triggers.length; i++) {
          triggers[i].addEventListener("click", function (e) {
            lastFocused =
              e && e.currentTarget ? e.currentTarget : document.activeElement;
            setOpen(true);

            var url =
              currentInstallUrl || this.getAttribute("data-install-url");
            if (url) {
              triggerDownload(url);
              return;
            }

            // If the URL isn't ready yet, fetch it now (still no-cache/no-store).
            fetchInstallUrlFresh().then(function (freshUrl) {
              if (freshUrl) triggerDownload(freshUrl);
            });
          });
        }

        modal.addEventListener("click", function (e) {
          var target = e.target;
          if (!target) return;
          if (
            target.getAttribute &&
            target.getAttribute("data-close-modal") != null
          ) {
            setOpen(false);
          }
        });

        document.addEventListener("keydown", function (e) {
          if (modal.hidden) return;
          if (e.key === "Escape") setOpen(false);
        });
      })();
    </script>
  </body>
</html>
